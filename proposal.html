<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Directory Upload</title>
    <script src="//www.w3.org/Tools/respec/respec-w3c-common.js" async class="remove"></script>
    <script class="remove">
      var respecConfig = {
        shortName:      "DirectoryUpload",
        specStatus:     "unofficial",
        editors:        [{name: "Ali Alabbas", company: "Microsoft"},
                         {name: "Israel Hilerio", company: "Microsoft"},
                         {name: "Adrian Bateman", company: "Microsoft"}],
        processVersion: 2005,
        wg:             "Web Applications Working Group",
        wgURI:          "http://www.w3.org/2008/webapps/"
      };
    </script>
  </head>
  <body>
    <section id="abstract">
      <p>
        This spec aims to enable directory uploading by allowing a developer to read directory contents (files and sub-directories) asynchronously and be able to reconstruct the directory structure.
      </p>
    </section>
    <section id="sotd">
      <p>
        This spec is currently being proposed with the expectation that there may be changes.
      </p>
    </section>
    <section>
      <h2>Background</h2>
      <p>Websites are currently able to provide functionality for uploading files by using <code class="hightlight">&lt;input type="file" multiple></code> and drag and drop. However, there currently is no standard solution to handle directories and cases that involve a mix of files and directories.</p>
    </section>
    <section>
      <h2>Scenarios</h2>
      <p>The following scenarios are in scope for this proposal:</p>
      <ol>
        <li>Users are able to select one or more directories using a file dialog</li>
        <li>Users are able to select a combination of directories and files using a file dialog</li>
        <li>Users are able to select one or more directories via drag and drop</li>
        <li>Users are able to select a combination of directories and files via drag and drop</li>
      </ol>
      <p>To address scenario 1 and 2, the HTML5 input tag needs a new attribute that can allow a user to select a directory as well as files. In addition, the HTMLInputElement needs an attribute for retrieving the directory so that it can be traversed. For scenario 3 and 4, DataTransfer needs an attribute for retrieving a virtual root directory holding all the sub-directories and files dropped in so that it can be traversed. To enable these scenarios, a Directory interface needs to be defined allowing the following: retrieving a list of its contents, reporting its relative path, and reporting its name.</p>
    </section>
    <section>
      <h2>APIs</h2>
      <section>
        <h2>Directory Interface</h2>
        <p>More information about the Directory interface can be found in the <a href="http://w3c.github.io/filesystem-api/#idl-def-Directory">FileSystem API</a>.</p>
        <dl class="idl" title="[Exposed=Window,Worker] partial interface Directory">
          <dt>readonly attribute DOMString name</dt>
          <dd>Returns the name of the directory.</dd>
          <dt>readonly attribute DOMString path</dt>
          <dd>Returns the directory's path relative to the root directory.</dd>
          <dt>Promise&lt;sequence&lt;(File or Directory)>> getContents ()</dt>
          <dd>If the <a>Directory</a> has files or sub-directories, a <code>Promise</code> is returned that resolves with a <code>sequence</code> of <code>File</code> and/or <a>Directory</a> which represent a snapshot of the <a>Directory</a>'s contents. If the <a>Directory</a> is empty, a <code>Promise</code> is returned that resolves with an empty <code>sequence</code>. See <a href="http://w3c.github.io/filesystem-api/#widl-Directory-enumerate-Observable--File-or-Directory---DOMString-path">enumerate</a> in FileSystem API spec for more information.</dd>
        </dl>
      </section>
      <section>
        <h2>File Input</h2>
        <p>More information about the HTMLInputElement interface can be found in the <a href="http://www.w3.org/html/wg/drafts/html/CR/forms.html#the-input-element">HTML5 spec</a>.</p>
        <dl class="idl" title="partial interface HTMLInputElement : HTMLElement">
          <dt>attribute DOMString directory</dt>
          <dd>Having the <code class="highlight">directory</code> attribute enables the directory picker.
            <pre class="example highlight" title="HTML">
              &lt;input type="file" id="fileInput" directory multiple />
                    &lt;!-- Supports being able to select multiple files and/or directories -->
            </pre>
            <table class="parameters">
              <thead>
                <tr>
                  <th><strong>Attribute(s)</strong></th>
                  <th><strong>File</strong></th>
                  <th><strong>Files</strong></th>
                  <th><strong>Dir</strong></th>
                  <th><strong>Dirs</strong></th>
                  <th><strong>Sample UI</strong></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>&lt;input type=&quot;file&quot;&gt;</td>
                  <td>&check;</td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td>
                    <pre>
+-------------------------------------+
|                       | Choose file |
+-------------------------------------+
</pre>
                  </td>
                </tr>
                <tr>
                  <td>&lt;input type=&quot;file&quot; <strong>multiple</strong>&gt;</td>
                  <td>&check;</td>
                  <td>&check;</td>
                  <td></td>
                  <td></td>
                  <td>
                    <pre>
+-------------------------------------+
|                    | Choose file(s) |
+-------------------------------------+
</pre>
                  </td>
                </tr>
                <tr>
                  <td>&lt;input type=&quot;file&quot; <strong>directory</strong>&gt;</td>
                  <td></td>
                  <td></td>
                  <td>&check;</td>
                  <td></td>
                  <td>
                    <pre>
+-------------------------------------+
|                  | Choose directory |
+-------------------------------------+
</pre>
                  </td>
                </tr>
                <tr>
                  <td>&lt;input type=&quot;file&quot; <strong>directory</strong> <strong>multiple</strong>&gt;</td>
                  <td>&check;</td>
                  <td>&check;</td>
                  <td>&check;</td>
                  <td>&check;</td>
                  <td>
                   <pre>
+-------------------------------------+
|                    | Choose file(s) |
+-------------------------------------+
</pre>
                    or (if not supported, i.e. <a href="#widl-HTMLInputElement-isFilesAndDirectoriesSupported"><code>isFilesAndDirectoriesSupported</code></a> is false):
                    <pre>
+-------------------------------------+
|  Choose files  |  Choose directory  |
+-------------------------------------+
</pre>
                </tr>
              </tbody>
            </table>
          </dd>
          <dt>readonly attribute Directory rootDirectory</dt>
          <dd>Returns a read-only virtual root <a>Directory</a> where <a href="#widl-Directory-getContents-Promise-sequence--File-or-Directory"><code>getContents</code></a> returns the files and directories chosen.
            <pre class="example highlight" title="JavaScript">
              var input = document.getElementById('fileInput');

              input.rootDirectory.getContents().then(function(filesAndDirs) {
                  // iterate through each item
                  // see example below for more details
              });
            </pre>
          </dd>
          <dt>readonly attribute boolean isFilesAndDirectoriesSupported</dt>
          <dd>True if the OS is capable of picking files and/or directories, false otherwise.</dd>
          <dt>void chooseDirectory()</dt>
          <dd>Triggers the directory picker if <a href="#widl-HTMLInputElement-isFilesAndDirectoriesSupported"><code>isFilesAndDirectoriesSupported</code></a> is false, otherwise triggers the default click behavior of the input element.</dd>
        </dl>
        <section>
          <h2>Form Submission</h2>
          <p>When a form is submitted with <code class="highlight">enctype="multipart/form-data"</code> and a file input with the <code class="highlight">directory</code> attribute it must follow the following pattern in its request payload:</p>
          <pre class="example highlight">
------Boundary
Content-Disposition: form-data; name="file"; filename="docs/1.txt"
Content-Type: text/plain

[DATA]
------Boundary
Content-Disposition: form-data; name="file"; filename="docs/path/2.txt"
Content-Type: text/plain

[DATA]
------Boundary
Content-Disposition: form-data; name="file"; filename="docs/path/to/3.txt"
Content-Type: text/plain

[DATA]
------Boundary--
          </pre>
          <p>
            Directories that are empty will not be included in the request payload. This will make it backwards compatible with server scripts that only expect files.
          </p>
        </section>
      </section>
      <section>
        <h2>Drag and Drop</h2>
        <p>More information about the DataTransfer interface can be found in the <a href="http://www.w3.org/TR/2010/WD-html5-20101019/dnd.html#datatransfer">HTML5 spec</a>.</p>
        <dl class="idl" title="partial interface DataTransfer">
          <dt>readonly attribute Directory rootDirectory</dt>
          <dd>Returns a read-only virtual root <a>Directory</a> where <a href="#widl-Directory-getContents-Promise-sequence--File-or-Directory"><code>getContents</code></a> returns the files and directories chosen.
            <pre class="example highlight" title="JavaScript">
              document.getElementById('dropDiv').addEventListener('drop', function (e) {
                  e.stopPropagation();
                  e.preventDefault();

                  var uploadFile = function(file, path) {
                      // handle file uploading
                  };

                  var traverse = function(dir) {
                      dir.getContents().then(function(filesAndDirs) {
                          // iterate through all enumerated items
                          for (var i = 0; i < filesAndDirs.length; i++) {
                              if (typeof filesAndDirs[i].getContents === 'function') {
                                  // this recursion enables deep traversal of directories
                                  traverse(filesAndDirs[i]);
                              } else {
                                  uploadFile(filesAndDirs[i], dir.path);
                              }
                          }
                      });
                  };

                  // begin by traversing the DataTransfer's read-only virtual directory
                  // containing all files/directories dropped in
                  traverse(e.dataTransfer.rootDirectory);
              });
            </pre>
          </dd>
        </dl>
      </section>
    </section>
    <section>
      <h2>Appendix</h2>
      <section>
        <h2>FAQ</h2>
        <ol>
          <li>Why did we use getContents() instead of enumerate()?</li>
          <ul>
            <li>We want to be able to save the enumerate() name for the future when we have Observables available so that we can have enumerate() return an Observable.</li>
          </ul>
          <li>Why are we returning Promise for getContents() instead of an Observable?</li>
          <ul>
            <li>The directory upload scenario does not require listening on changes to the file system, therefore Observables would not be warranted.</li>
            <li>Observables, though undoubtedly advantageous in the enumeration scenario, are not well defined yet and it may take a long time before they are.</li>
            <li>We want to build a solution using today's primitives (such as Promises) and then, if necessary, we can retrofit the API for future primitives (such as Observables) when they are available and well defined.</li>
          </ul>
          <li>Why are we returning an Array in the Promise?</li>
          <ul>
            <li>Provides a snapshot of the directories and files at the time that getContents() is called. Developers would expect this for directory upload.</li>
            <li>An array allows iterating through the File and Directory objects.</li>
          </ul>
          <li>Why did we remove enumerateDeep() from the originally proposed Directory interface?</li>
          <ul>
            <li>It is not needed for the time being as recursively calling the getContents() function would fulfill the scenario that enumerateDeep() was meant to fulfill.</li>
            <li>getContents() would provide a smaller result set compared to enumerateDeep().</li>
          </ul>
          <li>Why is it ok to remove the other methods from the originally proposed Directory interface?</li>
          <ul>
            <li>Since the focus is on read-only scenarios to enable directory uploading, only a subset of the APIs are needed.</li>
            <li>The Directory interface will be extensible for the future when we need to address scenarios that involve writing.</li>
          </ul>
          <li>Why do we have a read-only virtual directory?</li>
          <ul>
            <li>A virtual directory that holds the collection of files/directories that are dropped or selected via a dialog would allow a developer to operate on the directory using the Directory interface which is extensible should we need to add any new methods/attributes to the Directory interface that we would like to use in the read-only case.</li>
          </ul>
        </ol>
      </section>
    </section>
  </body>
</html>
